connect

set datasourceJNDI=${datasourceJNDI}
set datasourceUser=${datasourceUser}
set datasourcePassword=${datasourcePassword}
set datasourceURL=${datasourceURL}
set hostname=${hostname}
set clusterPassword=${clusterPassword}

if (outcome != success) of /system-property=jboss.messaging.cluster.password:read-resource
  /system-property=jboss.messaging.cluster.password:add(value=$clusterPassword)
end-if

echo Ensuring full-ha profile in main server group
/server-group=main-server-group:write-attribute(name=profile,value=full-ha)
/server-group=main-server-group:write-attribute(name=socket-binding-group, value=full-ha-sockets)

echo Setting up hostname
if (outcome != success) of /profile=full-ha/subsystem=undertow/server=default-server/host=restful-ptv:read-resource
/profile=full-ha/subsystem=undertow/server=default-server/host=restful-ptv:add(alias=["$hostname"])
end-if

echo Remove profile default
if (outcome == success) of /profile=default:read-resource
  /profile=default:remove()
end-if

echo Remove profile full
if (outcome == success) of /profile=full:read-resource
  /profile=full:remove()
end-if

echo Remove profile ha
if (outcome == success) of /profile=ha:read-resource
  /profile=ha:remove()
end-if
 
echo Setting up JDBC Driver
if (outcome != success) of /profile=full-ha/subsystem=datasources/jdbc-driver=mysql:read-resource
  /profile=full-ha/subsystem=datasources/jdbc-driver=mysql:add(xa-datasource-class=com.mysql.jdbc.jdbc2.optional.MysqlXADataSource,driver-module-name=com.mysql.jdbc,driver-name=mysql)
end-if

echo Setting up datasource
if (outcome != success) of /profile=full-ha/subsystem=datasources/data-source=restful-ptv-cache:read-resource
  /profile=full-ha/subsystem=datasources/data-source=restful-ptv-cache:add(jta=true, jndi-name=$datasourceJNDI, enabled=true, use-ccm=true, connection-url=$datasourceURL, driver-name=mysql, user-name=$datasourceUser, password=$datasourcePassword, validate-on-match=false, check-valid-connection-sql=SELECT\ 1, share-prepared-statements=false)
else
  /profile=full-ha/subsystem=datasources/data-source=restful-ptv-cache:write-attribute(name=connection-url,value=$datasourceURL)
  /profile=full-ha/subsystem=datasources/data-source=restful-ptv-cache:write-attribute(name=user-name,value=$datasourceUser)
  /profile=full-ha/subsystem=datasources/data-source=restful-ptv-cache:write-attribute(name=password,value=$datasourcePassword)
end-if

echo Setting up cache container
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api:add()
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/transport=TRANSPORT:add(lock-timeout=60000)
end-if

echo Setting up organization cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=organizations/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up service cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=services/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up servicechannels cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicechannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up electronicchannel cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=electronicchannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up servicelocationchannel cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=servicelocationchannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up printableformchannel cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=printableformchannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up phonechannel cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=phonechannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up webpagechannel cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=webpagechannels/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up statutorydescriptions cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=statutorydescriptions/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

echo Setting up indexcache cache
if (outcome != success) of /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache:read-resource
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache:add(mode=SYNC)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache/component=state-transfer:add(enabled=true)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache/component=transaction:add(mode=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache/component=eviction:add(max-entries=-1,strategy=NONE)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache/component=expiration:add(interval=-1,lifespan=-1,max-idle=-1)
  /profile=full-ha/subsystem=infinispan/cache-container=kunta-api/replicated-cache=indexcache/string-keyed-jdbc-store=STRING_KEYED_JDBC_STORE:add(purge=false,passivation=false,fetch-state=true,preload=true,shared=true,datasource=java:jboss/datasources/restful-ptv-cache,dialect=MYSQL,string-keyed-table={id-column={type=VARCHAR(255)}, data-column={type=LONGBLOB}})
end-if

deploy /snap/restful-ptv-server/current/war/restful-ptv-server-{{ RESTFUL_PTV_SERVER_VERSION }}.war --all-server-groups
